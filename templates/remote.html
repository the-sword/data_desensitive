{% extends "base.html" %}

{% block title %}{{ t('remote_title') }} - {{ t('app_title') }}{% endblock %}

{% block content %}
<div id="remoteRoot" class="container py-4" data-authed="{{ 'true' if authed else 'false' }}">
  <h1 class="mb-3">{{ t('remote_title') }}</h1>

  {% if not authed %}
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-3">{{ t('remote_login') }}</h5>
          {% if login_error %}
          <div class="alert alert-danger" role="alert">{{ login_error }}</div>
          {% endif %}
          <form method="post" action="/remote/login">
            <div class="mb-3">
              <label for="username" class="form-label">{{ t('remote_username') }}</label>
              <input type="text" class="form-control" id="username" name="username" required>
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">{{ t('remote_password') }}</label>
              <input type="password" class="form-control" id="password" name="password" required>
            </div>
            <button type="submit" class="btn btn-primary">{{ t('remote_signin') }}</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% else %}
  <div class="card remote-card">
    <div class="card-body">
      <div class="d-flex flex-wrap justify-content-between align-items-end gap-2 mb-3">
        <div class="me-auto" style="min-width:240px;">
          <label class="form-label mb-1">{{ t('remote_select_region') }}</label>
          <select id="regionSelect" class="form-select form-select-sm">
            <option value="europe">{{ t('server_europe') }}</option>
            <option value="america">{{ t('server_america') }}</option>
            <option value="asia">{{ t('server_asia') }}</option>
          </select>
        </div>
        <div class="folder-toolbar d-flex">
          <button id="refreshBtn" class="btn btn-outline-primary btn-sm">{{ t('remote_refresh') }}</button>
          <button id="downloadBtn" class="btn btn-success btn-sm">{{ t('remote_download') }}</button>
          <form method="post" action="/remote/logout" class="d-inline ms-2">
            <button class="btn btn-outline-secondary btn-sm">{{ t('remote_logout') }}</button>
          </form>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-12">
          <label class="form-label mb-2">{{ t('remote_select_folder') }}</label>
          <div id="folderList" class="list-group list-fixed"></div>
          <div id="listStatus" class="text-muted small mt-2"></div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const root = document.getElementById('remoteRoot');
  const authed = root && root.dataset.authed === 'true';
  if (!authed) return;
  const regionEl = document.getElementById('regionSelect');
  const folderListEl = document.getElementById('folderList');
  const refreshBtn = document.getElementById('refreshBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const statusEl = document.getElementById('listStatus');
  let selectedFolder = '';

  async function loadFolders(){
    const region = regionEl.value;
    statusEl.textContent = '...';
    selectedFolder = '';
    folderListEl.innerHTML = '';
    try {
      const resp = await fetch(`/remote/list?region=${encodeURIComponent(region)}`);
      if (!resp.ok) throw new Error('Failed');
      const data = await resp.json();
      const folders = Array.isArray(data.folders) ? data.folders : [];
      folders.forEach(name => {
        const a = document.createElement('a');
        a.href = '#';
        a.className = 'list-group-item list-group-item-action';
        a.textContent = name;
        a.addEventListener('click', (e)=>{
          e.preventDefault();
          // clear active
          [...folderListEl.querySelectorAll('.list-group-item')].forEach(item=> item.classList.remove('active'));
          a.classList.add('active');
          selectedFolder = name;
        });
        folderListEl.appendChild(a);
      });
      statusEl.textContent = `${folders.length} folders`;
    } catch(e){
      statusEl.textContent = 'Error loading folders';
    }
  }

  refreshBtn.addEventListener('click', (e)=>{ e.preventDefault(); loadFolders(); });
  regionEl.addEventListener('change', loadFolders);
  downloadBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    const region = regionEl.value;
    if (!selectedFolder) return;
    window.location.href = `/remote/download?region=${encodeURIComponent(region)}&folder=${encodeURIComponent(selectedFolder)}`;
  });

  // initial load
  loadFolders();
})();
</script>
{% endblock %}

{% block extra_css %}
<style>
  .remote-card { box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #eee; }
  .list-fixed { max-height: 420px; overflow: auto; }
  .list-group-item.active { background-color: #0d6efd; border-color: #0d6efd; }
  @media (max-width: 576px){
    .folder-toolbar { width: 100%; justify-content: flex-start; }
  }
</style>
{% endblock %}

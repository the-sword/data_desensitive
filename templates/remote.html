{% extends "base.html" %}

{% block title %}{{ t('remote_title') }} - {{ t('app_title') }}{% endblock %}

{% block content %}
<div id="remoteRoot" class="container py-4" data-authed="{{ 'true' if authed else 'false' }}">
  <h1 class="mb-3">{{ t('remote_title') }}</h1>

  {% if not authed %}
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-3">{{ t('remote_login') }}</h5>
          {% if login_error %}
          <div class="alert alert-danger" role="alert">{{ login_error }}</div>
          {% endif %}
          <form method="post" action="/remote/login">
            <div class="mb-3">
              <label for="username" class="form-label">{{ t('remote_username') }}</label>
              <input type="text" class="form-control" id="username" name="username" required>
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">{{ t('remote_password') }}</label>
              <input type="password" class="form-control" id="password" name="password" required>
            </div>
            <button type="submit" class="btn btn-primary">{{ t('remote_signin') }}</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% else %}
  <div class="card remote-card">
    <div class="card-body">
      <div class="d-flex flex-wrap justify-content-between align-items-end gap-2 mb-3">
        <div class="me-auto" style="min-width:240px;">
          <label class="form-label mb-1">{{ t('remote_select_region') }}</label>
          <select id="regionSelect" class="form-select form-select-sm">
            <option value="europe">{{ t('server_europe') }}</option>
            <option value="america">{{ t('server_america') }}</option>
            <option value="asia">{{ t('server_asia') }}</option>
          </select>
        </div>
        <div class="folder-toolbar d-flex">
          <button id="refreshBtn" class="btn btn-outline-primary btn-sm">{{ t('remote_refresh') }}</button>
          <button id="downloadBtn" class="btn btn-success btn-sm">{{ t('remote_download') }}</button>
          <form method="post" action="/remote/logout" class="d-inline ms-2">
            <button class="btn btn-outline-secondary btn-sm">{{ t('remote_logout') }}</button>
          </form>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label mb-2">{{ t('remote_select_folder') }}</label>
          <div id="folderList" class="list-group list-fixed"></div>
          <div id="listStatus" class="text-muted small mt-2"></div>
        </div>
        <div class="col-md-4">
          <label class="form-label mb-2">Files</label>
          <div id="fileList" class="list-group list-fixed"></div>
          <div id="fileStatus" class="text-muted small mt-2"></div>
        </div>
        <div class="col-md-5">
          <label class="form-label mb-2">Preview</label>
          <div id="previewArea2" class="border rounded p-2 bg-light text-center preview-area">
            <img id="previewImg2" alt="preview2" class="img-fluid d-none" />
            <div id="previewHint2" class="text-muted small">Select an image to preview</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const root = document.getElementById('remoteRoot');
  const authed = root && root.dataset.authed === 'true';
  if (!authed) return;
  const regionEl = document.getElementById('regionSelect');
  const folderListEl = document.getElementById('folderList');
  const fileListEl = document.getElementById('fileList');
  const refreshBtn = document.getElementById('refreshBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const statusEl = document.getElementById('listStatus');
  const fileStatusEl = document.getElementById('fileStatus');
  const previewImg2 = document.getElementById('previewImg2');
  const previewHint2 = document.getElementById('previewHint2');
  let selectedFolder = '';

  async function loadFolders(){
    const region = regionEl.value;
    statusEl.textContent = '...';
    selectedFolder = '';
    folderListEl.innerHTML = '';
    fileListEl.innerHTML = '';
    fileStatusEl.textContent = '';
    try {
      const resp = await fetch(`/remote/list?region=${encodeURIComponent(region)}`);
      if (!resp.ok) throw new Error('Failed');
      const data = await resp.json();
      const folders = Array.isArray(data.folders) ? data.folders : [];
      folders.forEach(name => {
        const a = document.createElement('a');
        a.href = '#';
        a.className = 'list-group-item list-group-item-action';
        a.textContent = name;
        a.addEventListener('click', (e)=>{
          e.preventDefault();
          // clear active
          [...folderListEl.querySelectorAll('.list-group-item')].forEach(item=> item.classList.remove('active'));
          a.classList.add('active');
          selectedFolder = name;
          loadFiles();
        });
        folderListEl.appendChild(a);
      });
      statusEl.textContent = `${folders.length} folders`;
      // auto select first folder
      if (folders.length > 0) {
        const first = folderListEl.querySelector('.list-group-item');
        if (first) {
          first.classList.add('active');
          selectedFolder = first.textContent;
          await loadFiles();
        }
      }
    } catch(e){
      statusEl.textContent = 'Error loading folders';
    }
  }

  async function loadFiles(){
    const region = regionEl.value;
    const folder = selectedFolder;
    if (!folder){
      fileListEl.innerHTML = '';
      fileStatusEl.textContent = '';
      clearPreview();
      return;
    }
    fileStatusEl.textContent = '...';
    fileListEl.innerHTML = '';
    clearPreview();
    try {
      const resp = await fetch(`/remote/files?region=${encodeURIComponent(region)}&folder=${encodeURIComponent(folder)}`);
      if (!resp.ok) throw new Error('Failed');
      const data = await resp.json();
      const files = Array.isArray(data.files) ? data.files : [];
      files.forEach(f => {
        const a = document.createElement('a');
        a.href = '#';
        a.className = 'list-group-item list-group-item-action';
        const size = (typeof f.size === 'number') ? ` (${f.size} B)` : '';
        a.textContent = `${f.name}${size}`;
        a.addEventListener('click', (e)=>{
          e.preventDefault();
          // set active
          [...fileListEl.querySelectorAll('.list-group-item')].forEach(item=> item.classList.remove('active'));
          a.classList.add('active');
          showPreview(f.name);
        });
        fileListEl.appendChild(a);
      });
      fileStatusEl.textContent = `${files.length} files`;
      // auto preview first image
      const firstImg = files.find(f => isImageName(f.name));
      if (firstImg) {
        const toActivate = [...fileListEl.querySelectorAll('.list-group-item')].find(el => el.textContent.startsWith(firstImg.name));
        if (toActivate) toActivate.classList.add('active');
        showPreview(firstImg.name);
      } else {
        clearPreview();
      }
    } catch(e){
      fileStatusEl.textContent = 'Error loading files';
    }
  }

  function isImageName(name){
    return /\.(png|jpe?g|bmp|gif|webp|tiff?)$/i.test(name);
  }

  function clearPreview(){
    previewImg2.src = '';
    previewImg2.classList.add('d-none');
    previewHint2.textContent = 'Select an image to preview';
  }

  function showPreview(fileName){
    if (!isImageName(fileName)){
      clearPreview();
      previewHint2.textContent = 'Not an image file';
      return;
    }
    const region = regionEl.value;
    const url = `/remote/file?region=${encodeURIComponent(region)}&folder=${encodeURIComponent(selectedFolder)}&name=${encodeURIComponent(fileName)}`;
    previewImg2.src = url;
    previewImg2.classList.remove('d-none');
    previewHint2.textContent = fileName;
  }

  refreshBtn.addEventListener('click', (e)=>{ e.preventDefault(); loadFolders(); });
  regionEl.addEventListener('change', loadFolders);
  downloadBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    const region = regionEl.value;
    if (!selectedFolder) return;
    window.location.href = `/remote/download?region=${encodeURIComponent(region)}&folder=${encodeURIComponent(selectedFolder)}`;
  });

  // initial load
  loadFolders();
})();
</script>
{% endblock %}

{% block extra_css %}
<style>
  .remote-card { box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #eee; }
  .list-fixed { max-height: 420px; overflow: auto; }
  .list-group-item.active { background-color: #0d6efd; border-color: #0d6efd; }
  @media (max-width: 576px){
    .folder-toolbar { width: 100%; justify-content: flex-start; }
  }
</style>
{% endblock %}
